name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

env:
  NX_CLOUD_DISTRIBUTED_EXECUTION: true
  NX_VERBOSE_LOGGING: false
  PRIMARY_NODE_VERSION: 12
  CI: true # Do we actually need this? Is it not true by default?

jobs:
  primary:
    name: Primary
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Derive appropriate SHAs for base and head for `nx affected` commands
      uses: jameshenry/nx-set-shas@v0.3
      with:
        error-on-no-matching-tags: false
        main-branch-name: master

    - name: Use Node.js ${{ env.PRIMARY_NODE_VERSION }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.PRIMARY_NODE_VERSION }}

    - name: Get yarn cache directory path and node version for cache key
      id: yarn-cache-dir-path
      run: |
        echo "::set-output name=dir::$(yarn cache dir)"
        echo "::set-output name=node_version::$(node --version)"

    - uses: actions/cache@v2
      id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-

    - name: Install dependencies (skipping postinstall)
      # We use --ignore-scripts to skip automatic postinstall and give us more control over distributing build tasks
      run: |
        yarn --ignore-engines --frozen-lockfile --prefer-offline --ignore-scripts
        yarn check-clean-workspace-after-install

    - name: Check code formatting (not distributable)
      run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn check-format

    - name: Lint markdown files (not distributable)
      run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn lint-markdown

    - name: Check spelling (not distributable)
      run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn check-spelling

    - run: yarn build
    - run: yarn typecheck
    - run: yarn test

    # We leverage our own plugins as part of linting, so this needs to come after build
    - name: Lint source files (not distributable)
      run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn lint

    - run: yarn test-integration

    - name: Publish code coverage report
      uses: codecov/codecov-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: unittest
        name: codecov

    - name: Tag master branch if all jobs succeed
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
      uses: jameshenry/nx-tag-successful-ci-run@v0.1

    - name: Stop all running agents for this CI run
      # It's important that we always run this step, otherwise in the case of any failures in preceding non-Nx steps, the agents will keep running and waste billable minutes
      if: ${{ always() }}
      run: npx nx-cloud stop-all-agents

  agents:
    name: Nx Distributed CI Agents
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        agent: [1, 2, 3, 4, 5, 6]
    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js ${{ env.PRIMARY_NODE_VERSION }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.PRIMARY_NODE_VERSION }}

      - name: Get yarn cache directory path and node version for cache key
        id: yarn-cache-dir-path
        run: |
          echo "::set-output name=dir::$(yarn cache dir)"
          echo "::set-output name=node_version::$(node --version)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-

      - name: Install dependencies (skipping postinstall)
        # We use --ignore-scripts to skip automatic postinstall and give us more control to distribute tasks
        run: yarn --ignore-engines --frozen-lockfile --prefer-offline --ignore-scripts

      - name: Start Nx Agent ${{ matrix.agent }}
        run: npx nx-cloud start-agent

  unit_tests_on_other_node_versions:
    name: Unit tests on other supported Node versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [10.x, 14.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: Get yarn cache directory path and node version for cache key
        id: yarn-cache-dir-path
        run: |
          echo "::set-output name=dir::$(yarn cache dir)"
          echo "::set-output name=node_version::$(node --version)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-

      - name: Install dependencies (skipping postinstall)
        # We use --ignore-scripts to skip automatic postinstall and give us more control to distribute tasks
        run: yarn --ignore-engines --frozen-lockfile --prefer-offline --ignore-scripts

      # We cannot distribute these because the agents are set up to run the primary node version, not this alternative we are testing
      - name: Run unit tests on Node ${{ matrix.node }} (not distributable)
        # @typescript-eslint/eslint-plugin-internal is internal only - so don't care about compat on other versions
        run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn test --exclude @typescript-eslint/eslint-plugin-internal

  publish_canary_version:
    name: Publish the latest code as a canary version
    runs-on: ubuntu-latest
    needs: [primary, unit_tests_on_other_node_versions]
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v2

      # Fetch all history for all tags and branches in this job because lerna needs it
      - run: git fetch --prune --unshallow

      - name: Use Node.js ${{ env.PRIMARY_NODE_VERSION }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.PRIMARY_NODE_VERSION }}
          registry-url: https://registry.npmjs.org/

      - name: Get yarn cache directory path and node version for cache key
        id: yarn-cache-dir-path
        run: |
          echo "::set-output name=dir::$(yarn cache dir)"
          echo "::set-output name=node_version::$(node --version)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.yarn-cache-dir-path.outputs.node_version }}-yarn-

      - name: Install dependencies (skipping postinstall)
        # We use --ignore-scripts to skip automatic postinstall and give us more control to distribute tasks
        run: yarn --ignore-engines --frozen-lockfile --prefer-offline --ignore-scripts

      - name: Run build ahead of publishing
        # We cannot distribute this because the agents have already been stopped by this point
        # but it should not matter because this should be a full cloud cache hit
        run: NX_CLOUD_DISTRIBUTED_EXECUTION=false yarn build

      - name: Publish all packages to npm
        run: npx lerna publish --loglevel=verbose --canary --exact --force-publish --yes
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
